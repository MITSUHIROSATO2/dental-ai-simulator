# Blenderからのアバターエクスポートガイド

## 前提条件
- Blender 2.8以上
- アバターモデルにシェイプキー（Shape Keys）が設定されていること

## シェイプキーの確認

1. Blenderでアバターモデルを開く
2. メッシュオブジェクトを選択
3. プロパティパネル → オブジェクトデータプロパティ（緑の三角形アイコン）
4. 「シェイプキー」セクションを確認
5. 以下のシェイプキーがあることを確認：
   - Basis（基本形状）
   - Viseme_A（「あ」の口の形）
   - Viseme_I（「い」の口の形）
   - Viseme_U（「う」の口の形）
   - Viseme_E（「え」の口の形）
   - Viseme_O（「お」の口の形）
   - その他必要なviseme

## GLBエクスポート手順

1. **ファイル → エクスポート → glTF 2.0 (.glb/.gltf)**

2. **エクスポート設定**：
   
   ### フォーマット
   - ✅ glTFバイナリ (.glb)を選択
   
   ### 含める
   - ✅ 選択したオブジェクト（または「表示レイヤー」）
   - ✅ カスタムプロパティ
   - ✅ カメラ（必要に応じて）
   - ✅ パンクチュアルライト（必要に応じて）
   
   ### トランスフォーム
   - ✅ +Yが上
   
   ### ジオメトリ
   - ✅ UVs
   - ✅ 法線
   - ✅ 接線（必要に応じて）
   - ✅ 頂点カラー（使用している場合）
   - ✅ マテリアル（エクスポート）
   - ⚠️ **シェイプキー** ← これが最も重要！必ずチェック！
   - ✅ シェイプキー法線（推奨）
   - ✅ シェイプキー接線（必要に応じて）
   
   ### アニメーション
   - ✅ アニメーション（アニメーションがある場合）
   - ✅ **シェイプキーアニメーション** ← これも重要！
   - ✅ スキニング（アーマチュアを使用している場合）
   - 🔘 サンプリングレート: 1（デフォルト）
   - ✅ 常にサンプルアニメーション
   - ✅ NLAトラック
   - ✅ 現在のフレームをエクスポート

3. **保存先**：
   ```
   /public/models/patient-avatar.glb
   ```

## トラブルシューティング

### シェイプキーがエクスポートされない場合

1. **シェイプキーの値を確認**
   - すべてのシェイプキーの値が0になっていることを確認
   - Basisの値が1.0であることを確認

2. **モディファイアの適用**
   - アーマチュアモディファイア以外のモディファイアは適用しておく
   - サブディビジョンサーフェスなどは適用推奨

3. **メッシュの結合**
   - 複数のメッシュがある場合、シェイプキーを持つメッシュを1つに結合

4. **Blenderバージョン**
   - Blender 3.0以上を推奨
   - 古いバージョンではglTFエクスポーターのバグがある可能性

### エクスポート後の確認

1. https://gltf-viewer.donmccurdy.com/ でGLBファイルを確認
2. 「Morph Targets」セクションにシェイプキーが表示されることを確認
3. スライダーを動かして形状が変化することを確認

## シェイプキーの作成方法（新規作成の場合）

1. メッシュを選択
2. オブジェクトデータプロパティ → シェイプキー
3. 「+」ボタンをクリックして「Basis」を作成
4. 再度「+」ボタンをクリックして新しいシェイプキーを作成
5. 名前を「Viseme_A」などに変更
6. 編集モードで頂点を移動して口の形を作成
7. オブジェクトモードに戻る
8. 各音素に対して繰り返す

## 推奨されるシェイプキー名

日本語の音声に対応するための基本セット：
- Viseme_A（あ）
- Viseme_I（い）
- Viseme_U（う）
- Viseme_E（え）
- Viseme_O（お）
- Viseme_M（ま行、ぱ行、ば行）
- Viseme_N（な行）
- Viseme_S（さ行）
- Viseme_T（た行）
- Viseme_F（ふ）
- Viseme_R（ら行）

表情用（オプション）：
- Mouth_Smile（笑顔）
- Mouth_Frown（しかめっ面）
- Brow_Up（眉を上げる）
- Brow_Down（眉を下げる）