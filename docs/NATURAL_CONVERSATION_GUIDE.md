# 自然会話モード実装ガイド

## 概要

このドキュメントでは、音声入力を自動化して自然な会話フローを実現する実装について説明します。

## 主な機能

### 1. 自動音声検出 (Voice Activity Detection)

- **リアルタイム音声レベル監視**: Web Audio APIを使用して、マイクからの入力音声レベルをリアルタイムで監視
- **音声アクティビティ表示**: 5段階のビジュアルインジケーターで音声の強さを表示
- **沈黙検出**: 音声が途切れてからの経過時間を自動計測

### 2. 自動送信機能

- **1.5秒ルール**: ユーザーが話し終わってから1.5秒の沈黙を検出すると自動的に送信
- **インテリジェント処理**: AI応答中や処理中は自動送信を一時停止
- **手動モード対応**: 自動モードをオフにして従来の手動送信も可能

### 3. 継続的な会話フロー

- **会話の継続**: AI応答が終了後も自動的に音声認識を再開
- **シームレスな体験**: ボタン操作なしで自然な対話が可能
- **エラー処理**: 音声認識エラー時も適切に復帰

## 技術的実装

### useAutoVoiceDetection フック

```typescript
// 主要な機能:
- 音声認識の自動再開
- 音声アクティビティレベルの計算
- 沈黙タイマーの管理
- 自動送信のトリガー
```

### 音声アクティビティ検出アルゴリズム

1. **周波数解析**: AnalyserNodeを使用して音声の周波数データを取得
2. **レベル計算**: 周波数データの平均値を計算して正規化
3. **閾値判定**: 0.1を超える場合を音声ありと判定
4. **沈黙計測**: 最後の音声検出からの経過時間を記録

### 自動送信ロジック

```typescript
// 条件:
1. 最終的な音声認識結果が確定
2. 自動モードが有効
3. 現在処理中またはAI応答中でない
4. 1.5秒の沈黙を検出

// 動作:
- タイマーをセットして1.5秒後に送信
- 新しい音声が検出されたらタイマーをリセット
```

## 使用方法

### 1. 基本的な使い方

```typescript
import { useAutoVoiceDetection } from '@/hooks/useAutoVoiceDetection';

// フック内で使用
const {
  transcript,
  isListening,
  startConversation,
  stopConversation,
  voiceActivityLevel,
  silenceTimer,
  isAutoMode,
  setAutoMode
} = useAutoVoiceDetection();

// 会話開始
startConversation((transcript) => {
  // 音声認識が完了したときの処理
  handleSendMessage(transcript);
});
```

### 2. 自然会話ページの実装

`/app/natural-conversation/page.tsx`では、以下の機能を実装:

- 会話の開始/停止ボタン
- 音声アクティビティインジケーター
- 自動/手動モードの切り替え
- リアルタイムの音声認識結果表示

## ユーザー体験の向上点

1. **ハンズフリー操作**: 一度会話を開始すれば、ボタン操作不要
2. **視覚的フィードバック**: 音声レベルと認識状態を常に表示
3. **適応的な待機時間**: 話し終わりを自動検出
4. **エラー回復**: 問題が発生しても会話を継続

## 今後の改善案

1. **カスタマイズ可能な沈黙時間**: ユーザーが待機時間を調整可能に
2. **ノイズキャンセリング**: 背景雑音の除去機能
3. **話者交代の検出**: より高度な会話フロー制御
4. **多言語対応**: 日本語以外の言語サポート

## トラブルシューティング

### 音声が認識されない場合

1. ブラウザの設定でマイクの使用が許可されているか確認
2. Chrome または Edge ブラウザを使用しているか確認
3. マイクが正しく接続されているか確認

### 自動送信が機能しない場合

1. 自動モードが有効になっているか確認
2. 1.5秒以上の沈黙があるか確認
3. AI応答中でないことを確認

### パフォーマンスの問題

1. 他のタブやアプリケーションを閉じる
2. ブラウザのキャッシュをクリア
3. 最新バージョンのブラウザを使用